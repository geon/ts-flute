var I=Object.defineProperty;var S=(a,o,c)=>o in a?I(a,o,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[o]=c;var i=(a,o,c)=>S(a,typeof o!="symbol"?o+"":o,c);(function(){"use strict";function a(r,e){class t extends AudioWorkletProcessor{constructor({processorOptions:h}){super();i(this,"toneOscilator");i(this,"midiMessages",[]);this.toneOscilator=e(h.sampleRate),this.toneOscilator.next(),this.port.onmessage=l=>{this.midiMessages.push(l.data)}}process(h,l,x){var d;const u=(d=l[0])==null?void 0:d[0];if(!u)throw new Error("Missing channel.");for(let p=0;p<u.length;p++)u[p]=this.toneOscilator.next(this.midiMessages.shift()).value;return!0}}registerProcessor(r,t)}function o(r){return function*(){const e=new Map;let t=0;for(;;){const s=yield t;if(s){let n=e.get(s.number);n||(n=r(sampleRate),e.set(s.number,n),n.next())}t=[...e.entries()].map(([n,h])=>h.next(n===(s==null?void 0:s.number)?s:void 0).value).reduce((n,h)=>n+h,0)}}}class c{constructor(e){i(this,"sinZ",0);i(this,"cosZ",0);this.frequency=e}step(e,t){const s=2*Math.PI*(this.frequency/sampleRate);this.sinZ=this.sinZ+this.cosZ*s,this.cosZ=this.cosZ-this.sinZ*s;const n=1e-4*(-1+2*Math.random());return this.sinZ=g(this.sinZ+n+t*s,e),this.sinZ}}function g(r,e){return Math.max(-e,Math.min(e,r))}class w{constructor(e,t){i(this,"samplesLeftToTarget");i(this,"current");i(this,"target");this.samplerate=e,this.samplesLeftToTarget=0,this.current=t,this.target=t}setTarget(e,t){this.target=e,this.samplesLeftToTarget=this.samplerate*t}step(){return this.samplesLeftToTarget&&(this.current+=(this.target-this.current)/this.samplesLeftToTarget,--this.samplesLeftToTarget),this.current}}function y(r){return 440*Math.pow(2,(r-69)/12)}const m=343;function T(r){return r/m}function L(r,e){const t=T(r);return m/e*t}class f{constructor(e){i(this,"cursor");i(this,"samples");if(!e)throw new Error("A delay line must have a size.");this.cursor=0,this.samples=[];for(let t=0;t<e;++t)this.samples[t]=0}read(){return this.samples[this.cursor]}write(e){this.samples[this.cursor]=e}step(){this.cursor=(this.cursor+1)%this.samples.length}}class M{constructor(e){i(this,"delayLines");this.delayLines=[new f(e),new f(e)]}read(){return[this.delayLines[0].read(),this.delayLines[1].read()]}write(e){this.delayLines[0].write(e[0]),this.delayLines[1].write(e[1])}step(){this.delayLines[0].step(),this.delayLines[1].step()}}const P="pan-flute";class Z{constructor(e,t){i(this,"pipe");i(this,"whistle");i(this,"volumeInterpolator");const s=L(e,t);this.pipe=new M(s),this.whistle=new c(t),this.volumeInterpolator=new w(e,0)}setVolumeTarget(e,t){this.volumeInterpolator.setTarget(e,t)}step(){const[t,s]=this.pipe.read(),n=this.whistle.step(this.volumeInterpolator.step(),s);return this.pipe.write([n+s*.75,t*.75]),this.pipe.step(),t}}function*b(r){let e;for(;;){const t=yield((e==null?void 0:e.step())??0)*.5;if(t)switch(t.type){case"noteon":{if(!e){const s=y(t.number);e=new Z(r,s)}e.setVolumeTarget(.7,.06);break}case"noteoff":{e==null||e.setVolumeTarget(0,.02);break}}}}function v(){a(P,o(b))}v()})();
